<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Scalability Challenge in Karobar Easy</title>

  
<meta name="title" content="Scalability Challenge in Karobar Easy">
<meta name="description" content="The Streamliners is a community of Problem Solvers. We solve Real-World problems. We encourage, guide, help &amp; mentor how to solve.">


<meta property="og:type" content="website">
<meta property="og:url" content="https://thestreamliners.in/blog/scalability-challenge-in-karobar-easy/">
<meta property="og:title" content="Scalability Challenge in Karobar Easy">
<meta property="og:description" content="The Streamliners is a community of Problem Solvers. We solve Real-World problems. We encourage, guide, help &amp; mentor how to solve.">
<meta property="og:image" content="https://thestreamliners.in/images/meta-image3.png">


<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://thestreamliners.in/blog/scalability-challenge-in-karobar-easy/">
<meta property="twitter:title" content="Scalability Challenge in Karobar Easy">
<meta property="twitter:description" content="The Streamliners is a community of Problem Solvers. We solve Real-World problems. We encourage, guide, help &amp; mentor how to solve.">
<meta property="twitter:image" content="https://thestreamliners.in/images/meta-image3.png">

  <!-- mobile responsive meta -->
  <meta name="theme-color" content="#3c51b2" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <!-- Slick Carousel -->
  <link rel="stylesheet" href="https://thestreamliners.in/plugins/slick/slick.css" />
  <link rel="stylesheet" href="https://thestreamliners.in/plugins/slick/slick-theme.css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://thestreamliners.in/plugins/font-awesome/css/font-awesome.min.css" />

  <!-- Magnific Popup -->
  <link rel="stylesheet" href="https://thestreamliners.in/plugins/magnafic-popup/magnific-popup.css" />

  <!-- Stylesheets -->
  
  <link href="https://thestreamliners.in/scss/style.min.css" rel="stylesheet" />

  <!--Favicon-->
  <link rel="shortcut icon" href="https://thestreamliners.in/images/favicon.png" type="image/x-icon" />
  <link rel="icon" href="https://thestreamliners.in/images/favicon.png" type="image/x-icon" />
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZQR6XDLDE5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js',  new Date());

    gtag('config', 'G-ZQR6XDLDE5');
  </script>
  
</head>

<body>
  <nav class="navbar navbar-expand-lg fixed-top">
  <div class="container">
    <a href="https://thestreamliners.in/" class="navbar-brand">
      <img src="https://thestreamliners.in/images/site-navigation/logo.svg" alt="The Streamliners">
    </a>
    <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#navbarCollapse">
      <span class="navbar-toggler-icon"></span>
      <span class="navbar-toggler-icon"></span>
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
      <ul class="nav navbar-nav main-navigation my-0 mx-auto">
        
        
        <li class="nav-item">
          <a href="https://thestreamliners.in/#home"
            class="nav-link text-dark text-sm-center p-2 ">Home</a>
        </li>
        
        <li class="nav-item">
          <a href="https://thestreamliners.in/#service"
            class="nav-link text-dark text-sm-center p-2 ">Services</a>
        </li>
        
        <li class="nav-item">
          <a href="https://thestreamliners.in/#portfolio"
            class="nav-link text-dark text-sm-center p-2 ">Portfolio</a>
        </li>
        
        <li class="nav-item">
          <a href="https://thestreamliners.in/#blog"
            class="nav-link text-dark text-sm-center p-2 ">Blogs</a>
        </li>
        
        <li class="nav-item">
          <a href="https://thestreamliners.in//contact"
            class="nav-link text-dark text-sm-center p-2 ">Contact</a>
        </li>
        
        <li class="nav-item">
          <a href="https://thestreamliners.in//about-us"
            class="nav-link text-dark text-sm-center p-2 ">About us</a>
        </li>
        
      </ul>
    
    </div>
  </div>
</nav>
  <div id="content">
    

<header class="breadCrumb">
  <div class="container">
    <div class="row">
      <div class="col-lg-10 col-md-12 offset-lg-1 offset-md-0 text-center">
        <h3 class="breadCrumb__title">Scalability Challenge in Karobar Easy</h3>

        <div class="row justify-content-center">
          <p>January 31, 2022 by <a href="../../authors/lavish-swarnkar">Lavish Swarnkar</a></p>
        </div>

        <nav aria-label="breadcrumb" class="d-flex justify-content-center">
          
          <ol class="breadcrumb align-items-center">
            <li class="breadcrumb-item"><a href=https://thestreamliners.in/>Home</a></li>
            <li class="breadcrumb-item"><a href=https://thestreamliners.in/blog>All Posts</a></li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
</header>

<section class="section singleBlog">
  <div class="svg-img">
      <img src=https://thestreamliners.in/images/hero/figure-svg.svg alt="">
  </div>
  <div class="animate-shape">
      
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 600 600">
          <defs>
              <linearGradient id="d" x1="0.929" y1="0.111" x2="0.263" y2="0.935" gradientUnits="objectBoundingBox">
                  <stop offset="0" stop-color="#f1f6f9" />
                  <stop offset="1" stop-color="#f1f6f9" stop-opacity="0" />
              </linearGradient>
          </defs>
          <g data-name="blob-shape (3)">
              <path class="blob" fill="url(#d)"
                  d="M455.4 151.1c43.1 36.7 73.4 92.8 60.8 136.3-12.7 43.5-68.1 74.4-111.3 119.4-43.1 45-74 104.1-109.8 109-35.9 5-76.7-44.2-111.8-89.2-35.2-45-64.7-85.8-70.8-132.6-6-46.8 11.6-99.6 46.7-136.3 35.2-36.6 88-57.2 142.4-58.8 54.5-1.7 110.6 15.6 153.8 52.2z" />
          </g>
      </svg>
  </div>
  <div class="animate-pattern">
      <img src=https://thestreamliners.in/images/service/background-pattern.svg alt="background-shape">
  </div>
  <div class="container">
      <div class="row">
          <div class="col-lg-12">
            
          </div>
      </div>
      <div class="row mt-5">
          <div class="col-lg-12">
              <div class="singleBlog__content">
                  <p>Namaskaram,</p>
<p>The recent growth in Karobar Easy users made the attendanceUpdater Cloud Function fail! This failure caused inconsistency in the database several times. It took 2 rewrites of the entire cloud function to finally fix the issue. This has been a challenging yet interesting journey for me. So, here I am sharing the incident with you all.</p>
<p>The <strong>attendanceUpdater</strong> Cloud Function (ClFn) runs at midnight everyday. It has the following responsibilities :</p>
<ul>
<li>
<p>Creating new cycles for staffs whose month ended the day before</p>
</li>
<li>
<p>Marking attendance for WPO (Weekly Paid Off) &amp; PH (Paid Holiday) staffs at 3 nodes in the database :</p>
<ul>
<li>
<p>currentAttendance</p>
</li>
<li>
<p>monthAttendance</p>
</li>
<li>
<p>cycle</p>
</li>
</ul>
</li>
</ul>
<h3 id="first-appearance">First Appearance</h3>
<p>At the time of V1 development when the cloud function was created for the first time (March 2021) , I tested it thoroughly to make sure everything works. And it did work perfectly fine until Nov-Dec 2021. That was the time when ClFn started failing. But sadly no organization noticed or at least reported the issue. Animesh bhaiya was the first one to finally report the issue last week, as - &ldquo;WPO nahi lag rahi hai!&rdquo;.</p>
<h3 id="no-errors-in-log">No errors in log!</h3>
<p>I checked the logs immediately but found no error reported there. I waited to see the bug myself the next day. So, I marked WPO for my organization&rsquo;s staff and waited for the ClFn to mark the attendance. To my surprise, it was marked successfully!</p>
<h3 id="it-was-weekend">It was Weekend!</h3>
<p>I noticed that the days ClFn failed were on Weekends. Rest of the days it worked as expected. Why? That&rsquo;s the day when the majority of the staff have WPO. I had no clue what the bug was &amp; why the ClFn was failing to mark attendance for a large number of staff.</p>
<h3 id="the-christmas-night">The Christmas night</h3>
<p>There was no error in ClFn logs for 2022. But I kept digging the logs, and finally found just one error reported on 25th Dec, 2021. It was <strong>&ldquo;Error 4 : Deadline exceeded&rdquo;</strong>. That was a sufficient hint for me. The error was of ClFn timeout. Every ClFn has 60 seconds as it&rsquo;s default timeout i.e. it has only 60s to complete its execution. After that it is terminated. And because of this forced termination, it was unable to even report the error in the logs.</p>
<h3 id="increase-the-timeout">Increase the timeout!</h3>
<p>I increased the timeout to it&rsquo;s maximum - <strong>9 minutes (540 seconds)</strong>. And I waited for the next Sunday. The day came but still the ClFn failed to mark attendance even after executing for <strong>7 mins 47 secs 78 ms ( or 467,078 ms)</strong>. Thank God, this time it threw the same error in the logs! Moreover, I was not satisfied with this - increase the timeout solution. Because marking WPO for just 173 staff took ~8 mins. And the maximum timeout for Firebase ClFn is 9 mins. How is this scalable?</p>
<h3 id="the-first-rewrite">The first rewrite</h3>
<p>I observed the ClFn&rsquo;s code carefully &amp; found that it included <strong>sequential execution &amp; Firebase Write Batches</strong>. Sequential execution means it was marking attendance for each staff one after one &amp; not in parallel which caused long execution time. Code was something like:</p>
<p>for each staff,</p>
<p>add attendance in</p>
<ul>
<li>
<p>CurrAttendance</p>
</li>
<li>
<p>MonthAttendance</p>
</li>
<li>
<p>Cycle</p>
<p>(Wait for completion then proceed to next!)</p>
</li>
</ul>
<p>Parallel execution was not possible because each organization has a single currentAttendance doc and for each staff, attendance has to be added there. If there was parallel execution, there is a high possibility of concurrent writes to a single document.</p>
<p>As a solution, I rewrote the code like this:</p>
<ul>
<li>
<p>add attendance of all staffs of an organization at once in the CurrAttendance doc</p>
</li>
<li>
<p>Run in parallel :</p>
<ul>
<li>
<p>For each staff, add attendance in</p>
<ul>
<li>
<p>MonthAttendance</p>
</li>
<li>
<p>Cycle</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>I waited for one more Sunday to see the improvement in execution time. But the problem was not yet solved. It failed once again! No error thrown this time. CurrAttendance marked successfully but MonthAttendance &amp; cycle of staff was not updated making the data inconsistent. Thanks to Mohit, who had written a script to mark attendance &amp; make the data consistent again. But the ClFn problem was not yet solved.</p>
<h3 id="acknowledgement-problem">Acknowledgement problem</h3>
<p>ClFn was simply ignoring the parallel execution code to mark attendance. After much brainstorming &amp; surfing, I found that ClFn needs to acknowledge when the execution completes. ClFn gets terminated after the last acknowledgement. The last acknowledgement in the ClFn was of creating CurrAttendance docs. I was bound NOT to send acknowledgement of parallel execution attendance marking code. How could I? How do I know which staff is the last one to finish marking attendance? It&rsquo;s all network requests. Any request could be the last one. So, the previous code was such that it didn&rsquo;t return any acknowledgement for marking attendance. Last acknowledgement was of creating CurrAttendance docs.</p>
<p>I was looking for all sorts of solutions (including RxJS) for returning this acknowledgement i.e. waiting for all staff&rsquo;s attendance to be marked &amp; finally telling Firebase that &ldquo;hey, I&rsquo;m done - now you may terminate&rdquo;. Finally I found the solution - <strong>Promise.all()</strong>, which is a very powerful function in Node.JS. It combines multiple requests and sends acknowledgement only when all have completed execution. I quickly rewrote the entire code using Promise.all().</p>
<h3 id="cant-wait">Can&rsquo;t wait!</h3>
<p>I couldn&rsquo;t wait for another Sunday to see if my solution worked. I had taken a backup of the entire data <strong>(7.7k docs)</strong> on Saturday night to restore in case ClFn makes the data inconsistent again. I quickly created a dummy project, imported the data and this time I tested the ClFn with actual data. Finally - finally, it worked! It marked attendance as expected for all the 173 staffs. Guess the execution time!!</p>
<h3 id="reduced-by-144x">Reduced by 144x</h3>
<p>Yeah, the rewrite of ClFn made it&rsquo;s <strong>execution time reduced by 144x</strong>. From <strong>~8 mins to just 3235 ms</strong>!</p>
<h3 id="how-scalable-now">How scalable now?</h3>
<p>The new code marked attendance of 173 staff in just ~3 seconds. Taking the same speed, it can mark attendance for as much as <strong>31,000 staff in single execution</strong> (540 seconds is the maximum timeout limit of Firebase ClFn) !</p>
<p>Now one might ask - What happens if the number of staff grows even more? It will require one more rewrite. We need to execute ClFn multiple times and divide the staff among different executions. For example, 3 executions can mark attendance of <strong>93,000 staff</strong>!</p>
<h3 id="so-no-more-inconsistency">So, no more inconsistency?</h3>
<p>No, can&rsquo;t promise that. Consider this : The cloud function first creates currAttendance docs for all orgs and then marks attendance individually for all staffs. In case, if any error occurs while doing so, for example - attendance marked in monthAttendance but failed to increment noOfPresent in cycle, then this will cause inconsistency. Yes, even with current code. One might suggest to use Transaction &amp; WriteBatch. Good solution, but it comes with its own limitations. Firebase supports a maximum of 500 writes per transaction / WriteBatch. Hence, I got rid of all previous WriteBatch in code to avoid scalability issues in future.</p>
<p>However, the code can be rewritten to perform separate WriteBatch for each staff. But again, concurrent additions to currAttendance will cause inconsistency problems. Pff&hellip;</p>
<p>What now? What if data goes inconsistent? Well, there are now logs for each error that takes place. So, it is required to regularly monitor ClFn health for any errors. And then manually correct them!</p>
<h3 id="and-its-resolved">And it&rsquo;s resolved!</h3>
<p>However, for now the problem is finally resolved with parallel execution &amp; Promise.all(). Here are the lessons I learnt from this entire incident :</p>
<ul>
<li>
<p>If it works now, it doesn&rsquo;t mean it will keep working!</p>
</li>
<li>
<p>Scalability comes with it&rsquo;s own challenges</p>
</li>
<li>
<p>There is always a way out</p>
</li>
<li>
<p>Never give up</p>
</li>
<li>
<p>Writing code in Node.JS is hard but not impossible</p>
</li>
<li>
<p>Challenges of working with Firebase Cloud Functions :</p>
<ul>
<li>
<p>Only Node.JS!</p>
</li>
<li>
<p>There are emulators, but you might not know the bug until it&rsquo;s executed with the actual data</p>
</li>
</ul>
</li>
</ul>
<p>That&rsquo;s it! This was how I tackled this - one of the biggest coding challenges in my life.</p>
<p>Thank you for reading.</p>

              </div>

              <div style="margin-top: 100px;" id="disqus_thread"></div>
<script>
    var disqus_config = function () {
        this.page.title = "Scalability Challenge in Karobar Easy";
        this.page.url = "https://thestreamliners.in/blog/scalability-challenge-in-karobar-easy/";
        this.page.identifier = "Scalability Challenge in Karobar Easy";
    };
    (function() {
        var d = document, s = d.createElement('script');
        
        s.src = 'https://the-streamliners.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
          </div>
          
      </div>
  </div>
</section>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

<style>

h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
    margin-top: 50px;
}

</style>


  </div>
  <section class="footer" id="contact">
	<div class="footer__background_shape">
		<svg viewBox="0 0 1920 79">
			<path d="M0 0h1920v79L0 0z" data-name="Path 1450" />
		</svg>
	</div>
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div class="footer__cta">
					<div class="shape-1">
						<svg xmlns="http://www.w3.org/2000/svg" width="357" height="315.029" viewBox="0 0 357 315.029">
							<path data-name="Path 1449"
								d="M76.1-157.222C91.746-135.8 87.2-94.273 99.993-61.945c12.7 32.328 42.661 55.459 39.248 73.282-3.318 17.823-40.007 30.337-65.6 43.325-25.5 12.988-39.912 26.545-60.01 42.566-20.1 16.116-46.074 34.6-63.328 27.682-17.349-6.921-25.976-39.153-59.915-59.82s-93.1-29.768-105.325-51.478 22.373-56.028 43.609-93.949c21.331-37.921 29.2-79.35 53.563-96.793 24.459-17.444 65.414-10.9 103.9-6.921 38.396 3.982 74.326 5.404 89.965 26.829z"
								transform="translate(217.489 188.626)" />
						</svg>
					</div>
					<div class="shape-2">
						<svg xmlns="http://www.w3.org/2000/svg" width="357" height="315.029" viewBox="0 0 357 315.029">
							<path data-name="Path 1449"
								d="M76.1-157.222C91.746-135.8 87.2-94.273 99.993-61.945c12.7 32.328 42.661 55.459 39.248 73.282-3.318 17.823-40.007 30.337-65.6 43.325-25.5 12.988-39.912 26.545-60.01 42.566-20.1 16.116-46.074 34.6-63.328 27.682-17.349-6.921-25.976-39.153-59.915-59.82s-93.1-29.768-105.325-51.478 22.373-56.028 43.609-93.949c21.331-37.921 29.2-79.35 53.563-96.793 24.459-17.444 65.414-10.9 103.9-6.921 38.396 3.982 74.326 5.404 89.965 26.829z"
								transform="translate(217.489 188.626)" />
						</svg>
					</div>
					<div class="text-light footer__cta_content">
						<span>Contact us</span>
						<h2 class="mb-0">Let’s make your dream come true</h2>
					</div>
					<div class="footer__cta_action">
						<a class="btn btn-light btn-zoom" href="https://thestreamliners.in/contact">Get in
							touch</a>
					</div>
				</div>
			</div>
		</div>
		<div class="row footer__widget">
			<div class="col-lg-4">
				<div class="footer__widget_logo mb-5">
					<img src="https://thestreamliners.in/images/site-navigation/footer-logo.svg" alt="The Streamliners">
				</div>
			</div>
			<div class="col-lg-4">
				<div class="text-light footer__widget_sitemap mb-5">
					<h4 class="base-font">Links</h4>
					<ul class="unstyle-list small">
						
						
						<li class="mb-2"><a class="text-light" href="https://thestreamliners.in/portfolio/locatin">LocatIN</a></li>
						
						<li class="mb-2"><a class="text-light" href="https://thestreamliners.in/portfolio/ju-eezy">JU eezy</a></li>
						
						<li class="mb-2"><a class="text-light" href="https://thestreamliners.in/cse-simplified">CSE Simplified</a></li>
						
						<li class="mb-2"><a class="text-light" href="https://thestreamliners.in/android-training">Android Training (For JECRCians)</a></li>
						
						<li class="mb-2"><a class="text-light" href="https://thestreamliners.in/android-training-ext">Android Training (For Outsiders)</a></li>
						
						<li class="mb-2"><a class="text-light" href="https://thestreamliners.in/about-us">About us</a></li>
						
					</ul>
				</div>
			</div>
			<div class="col-lg-4">
				<div class="text-light footer__widget_address mb-5">
					<h4 class="base-font">Address</h4>
					
					<ul class="fa-ul small">
						<li class="mb-2"><a class="text-light" href="tel:8005601797"><span class="fa-li"><i
										class="fa fa-phone"></i></span>8005601797</a></li>
						<li class="mb-2"><a class="text-light" href="mailto:thestreamliners.tech@gmail.com"><span class="fa-li"><i
										class="fa fa-envelope"></i></span>thestreamliners.tech@gmail.com</a></li>
						<li class="mb-2">
							<span class="fa-li"><i class="fa fa-map-marker"></i></span>Jaipur, Rajasthan</a>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<div class="row footer__footer">
			<div class="col-lg-6">
				<div class="footer__footer_copy text-light">
					<p>All rights reserved © The Streamliners 2021</p>
				</div>
			</div>
			<div class="col-lg-6">
				<div class="footer__footer_social">
					<ul class="unstyle-list">
						
						
						<li class="d-inline-block mx-2"><a class="text-light" target="_blank" href="https://www.linkedin.com/in/lavishswarnkar"><i
									class="fa fa-linkedin-square"></i></a>
						</li>
						
					</ul>
				</div>
			</div>
		</div>
	</div>
</section>
<script src="https://thestreamliners.in/plugins/jQuery/jquery.min.js"></script>
<script src="https://thestreamliners.in/plugins/bootstrap/bootstrap.min.js"></script>
<script src="https://thestreamliners.in/plugins/slick/slick.min.js"></script>
<script src="https://thestreamliners.in/plugins/waypoint/jquery.waypoints.min.js"></script>
<script src="https://thestreamliners.in/plugins/magnafic-popup/jquery.magnific-popup.min.js"></script>
<script src="https://thestreamliners.in/plugins/tweenmax/TweenMax.min.js"></script>
<script src="https://thestreamliners.in/plugins/imagesloaded/imagesloaded.min.js"></script>
<script src="https://thestreamliners.in/plugins/masonry/masonry.min.js"></script>

<script src="https://thestreamliners.in/js/form-handler.min.js"></script>

<script src="https://thestreamliners.in/js/script.min.js"></script>

</body>

</html>